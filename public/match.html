<!DOCTYPE html>
<html lang="es">
  <head>
    <link rel="icon" type="image/x-icon" href="img/GLOTIcon.png" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>G/LOT - Asociar</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .comfortaa {
        font-family: "Comfortaa", cursive;
      }

      .card {
        width: 180px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        font-weight: bold;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        user-select: none;
      }
      .correct {
        background-color: #f3f4f6; /* gray-100 */
        color: #4b5563; /* gray-700 */
      }
      .shake-animation {
        animation: shake 0.5s;
        animation-iteration-count: 1;
      }
      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        20%,
        60% {
          transform: translateX(-5px);
        }
        40%,
        80% {
          transform: translateX(5px);
        }
      }

      .drop-zone {
        width: 180px;
        height: 60px;
        background-color: #e5e7eb; /* gray-200 */
        border: 2px dashed #9ca3af; /* gray-400 */
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280; /* gray-500 */
        font-size: 1.1rem;
        font-weight: bold;
        transition: border-color 0.2s;
      }
      .drop-zone.drag-over {
        border-color: #3b82f6; /* blue-500 */
      }

      .draggable-item {
        cursor: grab;
        background-color: #f3f4f6;
        color: #4b5563;
      }

      .dialogue-bubble {
        top: 100%;
        right: 50%;
        transform: translateX(50%) translateY(10px);
        z-index: 10;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
      }
      .dialogue-bubble::before {
        content: "";
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-bottom: 15px solid #fff;
      }
      .help-button-container:hover .dialogue-bubble {
        opacity: 1;
        pointer-events: auto;
        transform: translateX(50%) translateY(0);
      }

      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 50;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease-in-out;
      }
      .modal-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }
      .modal-content {
        background-color: white;
        padding: 2.5rem;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        transform: translateY(-20px);
        transition: transform 0.3s ease-in-out;
      }
      .modal-overlay.active .modal-content {
        transform: translateY(0);
      }
    </style>
  </head>
  <body class="bg-white comfortaa min-h-screen flex flex-col items-center">
    <!-- Game Header -->
    <header
      class="bg-white p-6 md:p-8 w-full flex items-center justify-between shadow-sm border-b"
    >
      <div class="flex items-center space-x-4">
        <a
          onclick="goBack()"
          class="text-gray-600 hover:text-gray-900 transition duration-300"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-8 w-8"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M10 19l-7-7m0 0l7-7m-7 7h18"
            />
          </svg>
        </a>
        <div class="relative help-button-container">
          <h1 class="text-3xl font-bold text-gray-800">
            Asociar
            <span class="text-gray-400 cursor-pointer">?</span>
          </h1>
          <div
            class="dialogue-bubble absolute bg-white p-4 rounded-lg shadow-md w-64 text-sm text-left"
          >
            <p class="font-bold mb-2">Cómo jugar:</p>
            <p>
              Arrastra las traducciones correctas y suéltalas en el espacio en
              blanco al lado de cada palabra.
            </p>
          </div>
        </div>
      </div>
      <img
        src=""
        alt=""
        class="w-10 md:w-12 h-auto rounded-md shadow-md"
        id="language-flag"
      />
    </header>

    <!-- Main Game Area -->
    <main
      class="container mx-auto p-8 flex flex-col items-center flex-grow justify-center"
    >
      <div class="flex items-center space-x-12">
        <!-- Columna de Palabras -->
        <div id="words-column" class="flex flex-col space-y-4">
          <!-- Palabras generadas aquí -->
        </div>

        <!-- Flechas -->
        <div class="flex flex-col space-y-8">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-8 w-8 text-gray-400"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M17 8l4 4m0 0l-4 4m4-4H3"
            />
          </svg>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-8 w-8 text-gray-400"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M17 8l4 4m0 0l-4 4m4-4H3"
            />
          </svg>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-8 w-8 text-gray-400"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M17 8l4 4m0 0l-4 4m4-4H3"
            />
          </svg>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-8 w-8 text-gray-400"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M17 8l4 4m0 0l-4 4m4-4H3"
            />
          </svg>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-8 w-8 text-gray-400"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M17 8l4 4m0 0l-4 4m4-4H3"
            />
          </svg>
        </div>

        <!-- Columna de Espacios para Soltar -->
        <div id="drop-zones-column" class="flex flex-col space-y-4">
          <!-- Zonas de soltar generadas aquí -->
        </div>
      </div>
    </main>

    <!-- Draggable Translations -->
    <footer
      id="translations-container"
      class="mt-8 flex justify-center flex-wrap gap-4 p-4 rounded-xl shadow-lg bg-gray-100"
    >
      <!-- Traducciones arrastrables generadas aquí -->
    </footer>

    <!-- Counters -->
    <div
      class="fixed bottom-8 right-8 bg-gray-200 px-6 py-3 rounded-full shadow-md"
    >
      <span id="match-counter" class="text-xl font-bold">0/5</span>
    </div>
    <div
      class="fixed bottom-8 left-8 bg-gray-200 px-6 py-3 rounded-full shadow-md"
    >
      <span id="try-counter" class="text-xl font-bold">Intentos: 0</span>
    </div>

    <!-- Win Modal -->
    <div id="win-modal-overlay" class="modal-overlay">
      <div class="modal-content">
        <h2 class="text-3xl font-bold text-green-500 mb-4">¡Felicidades!</h2>
        <p class="text-xl mb-6">¡Has completado el juego de asociar!</p>
        <p id="final-tries" class="text-lg text-gray-700 mb-8"></p>
        <a
          href="lessons.html"
          class="bg-blue-400 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg transition duration-300"
        >
          Más lecciones
        </a>
      </div>
    </div>

    <script>
      // Verificar token antes de mostrar la página
      async function verifyTokenOrRedirect() {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "login.html";
          return;
        }
        try {
          const res = await fetch("/api/verify-token", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token }),
          });
          const result = await res.json();
          if (!result.valid) {
            localStorage.removeItem("token");
            window.location.href = "login.html";
          }
        } catch (err) {
          window.location.href = "login.html";
        }
      }
      verifyTokenOrRedirect();
      // Salir button logic

      function goBack() {
        localStorage.removeItem("lesson_id");
        window.location.href = "lessons.html";
      }

      document.addEventListener("DOMContentLoaded", async () => {
        const lessonid = localStorage.getItem("lesson_id");

        const leccion = await obtenerLeccion(lessonid);

        const wordsColumn = document.getElementById("words-column");
        const dropZonesColumn = document.getElementById("drop-zones-column");
        const translationsContainer = document.getElementById(
          "translations-container"
        );
        const matchCounter = document.getElementById("match-counter");
        const tryCounter = document.getElementById("try-counter");
        const winModalOverlay = document.getElementById("win-modal-overlay");
        const finalTriesText = document.getElementById("final-tries");

        let tries = 0;
        let correctMatches = 0;
        const totalPairs = leccion.palabras.length;
        const languageCode = localStorage.getItem("code");

        // Update the header text and flag

        const languageFlagElement = document.getElementById("language-flag");

        const countryCode = languageCode ? languageCode.toLowerCase() : null;
        if (countryCode) {
          languageFlagElement.src = `https://flagcdn.com/w160/${countryCode}.png`;
        }
        function initGame() {
          wordsColumn.innerHTML = "";
          dropZonesColumn.innerHTML = "";
          translationsContainer.innerHTML = "";

          const matches = [];
          for (let i = 0; i < leccion.palabras.length; i++) {
            matches.push({
              word: leccion.palabras[i],
              translation: leccion.traducciones[i],
            });
          }

          const shuffledTranslations = shuffle(leccion.traducciones);

          matches.forEach((pair) => {
            const wordCard = document.createElement("div");
            wordCard.classList.add("card", "bg-white", "text-gray-700");
            wordCard.textContent = pair.word;
            wordsColumn.appendChild(wordCard);

            const dropZone = document.createElement("div");
            dropZone.classList.add("drop-zone");
            dropZone.dataset.translation = pair.translation;
            dropZonesColumn.appendChild(dropZone);
          });

          shuffledTranslations.forEach((translation) => {
            const draggableItem = document.createElement("div");
            draggableItem.classList.add("card", "draggable-item");
            draggableItem.textContent = translation;
            draggableItem.setAttribute("draggable", true);
            draggableItem.dataset.translation = translation;
            translationsContainer.appendChild(draggableItem);
          });

          addEventListeners();
          updateCounters();
        }

        function shuffle(array) {
          for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
          }
          return array;
        }

        function addEventListeners() {
          const draggables = document.querySelectorAll(".draggable-item");
          const dropZones = document.querySelectorAll(".drop-zone");
          const body = document.body;

          draggables.forEach((draggable) => {
            draggable.addEventListener("dragstart", dragStart);
          });

          dropZones.forEach((dropZone) => {
            dropZone.addEventListener("dragover", dragOver);
            dropZone.addEventListener("dragleave", dragLeave);
            dropZone.addEventListener("drop", drop);
          });

          body.addEventListener("dragover", dragOverBody);
          body.addEventListener("drop", dropBody);
        }

        let draggedItem = null;

        function dragStart(e) {
          draggedItem = this;
          setTimeout(() => this.classList.add("hidden"), 0);
        }

        function dragOver(e) {
          e.preventDefault();
          this.classList.add("drag-over");
        }

        function dragLeave() {
          this.classList.remove("drag-over");
        }

        function drop(e) {
          e.preventDefault();
          this.classList.remove("drag-over");

          const correctTranslation = this.dataset.translation;
          const draggedTranslation = draggedItem.dataset.translation;

          tries++;
          updateCounters();

          if (correctTranslation === draggedTranslation) {
            this.textContent = draggedTranslation;
            this.classList.remove("drop-zone");
            this.classList.add("card");
            this.classList.add("bg-white");
            this.classList.add("text-gray-700");
            this.removeEventListener("drop", drop);
            draggedItem.remove();
            correctMatches++;
            updateCounters();
            if (correctMatches === totalPairs) {
              showWinModal();
              updateCounter(leccion._id, { jugadas: leccion.jugadas + 1 });
            }
          } else {
            draggedItem.classList.remove("hidden");
            draggedItem.classList.add("shake-animation");
            setTimeout(
              () => draggedItem.classList.remove("shake-animation"),
              500
            );
          }
        }

        function dragOverBody(e) {
          e.preventDefault();
        }

        function dropBody(e) {
          e.preventDefault();
          if (draggedItem) {
            draggedItem.classList.remove("hidden");
            draggedItem.classList.add("shake-animation");
            setTimeout(
              () => draggedItem.classList.remove("shake-animation"),
              500
            );
            draggedItem = null;
          }
        }

        function updateCounters() {
          matchCounter.textContent = `${correctMatches}/${totalPairs}`;
          tryCounter.textContent = `Intentos: ${tries}`;
        }

        function showWinModal() {
          finalTriesText.textContent = `Número de intentos: ${tries}`;
          winModalOverlay.classList.add("active");
          console.log("Juego completado. Intentos totales:", tries);
        }

        initGame();
      });

      async function obtenerLeccion(id) {
        const respuesta = await fetch(`/api/lecciones/${id}`, {
          method: "GET",
          headers: {
            Authorization: "Bearer " + localStorage.getItem("token"),
            "Content-Type": "application/json",
          },
        });

        if (!respuesta.ok) {
          const error = await respuesta.json();
          throw new Error(error.error || "Error al registrar lección");
        }
        const resultado = await respuesta.json();

        return resultado;
      }

      async function updateCounter(id, datos) {
        const respuesta = await fetch(`/api/lecciones/${id}/`, {
          method: "PUT",
          headers: {
            Authorization: "Bearer " + localStorage.getItem("token"),
            "Content-Type": "application/json",
          },
          body: JSON.stringify(datos),
        });

        if (!respuesta.ok) {
          const error = await respuesta.json();
          throw new Error(error.error || "Error al registrar lección");
        }
        const resultado = await respuesta.json();

        return resultado;
      }
    </script>
  </body>
</html>
