<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="icon" type="image/x-icon" href="img/GLOTIcon.png" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>G/LOT - Perfil</title>
  </head>
  <body>
    <!-- Existing content of the HTML file -->

    <script>
      // Verificar token antes de mostrar la p√°gina
      async function verifyTokenOrRedirect() {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "login.html";
          return;
        }
        try {
          const res = await fetch("/api/verify-token", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token }),
          });
          const result = await res.json();
          if (!result.valid) {
            localStorage.removeItem("token");
            window.location.href = "login.html";
          }
        } catch (err) {
          window.location.href = "login.html";
        }
      }
      verifyTokenOrRedirect();
      // Salir button logic
      document.addEventListener("DOMContentLoaded", async function () {
        const usuario = await obtenerUsuario(localStorage.getItem("usuario"));
        const salirBtn = document.querySelector('a[href="#"]:nth-child(4)');
        if (!localStorage.getItem("token")) {
          salirBtn.style.display = "none";
        } else {
          salirBtn.style.display = "inline-block";
          salirBtn.onclick = function (e) {
            e.preventDefault();
            localStorage.removeItem("token");
            localStorage.removeItem("datosToken");
            localStorage.removeItem("usuario");
            localStorage.removeItem("lang");
            localStorage.removeItem("code");
            window.location.href = "login.html";
          };
        }
      });

       async function obtenerUsuario(nombre) {
        const respuesta = await fetch(`/api/usuarios/${nombre}`, {
          method: "GET",
          headers: {
            Authorization: "Bearer " + localStorage.getItem("token"),
            "Content-Type": "application/json",
          },
        });

        if (!respuesta.ok) {
          const error = await respuesta.json();
          throw new Error(error.error || "Error al obtener usuario");
        }
        const resultado = await respuesta.json();
        return resultado;
      }

      async function actualizarUsuario(nombre, datos) {
        const respuesta = await fetch(`/api/usuarios/${nombre}`, {
          method: "PUT",
          headers: {
            Authorization: "Bearer " + localStorage.getItem("token"),
            "Content-Type": "application/json",
          },
          body: JSON.stringify(datos),
        });

        if (!respuesta.ok) {
          const error = await respuesta.json();
          throw new Error(error.error || "Error al actualizar usuario");
        }
        const resultado = await respuesta.json();

        return resultado;
      }
    </script>
  </body>
</html>
