<!DOCTYPE html>
<html lang="es">
  <head>
    <link rel="icon" type="image/x-icon" href="img/GLOTIcon.png" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>G/LOT - Aprender Idiomas</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .comfortaa {
        font-family: "Comfortaa", cursive;
      }
      .flagImg {
        border: 1px solid black;
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 50;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease-in-out;
      }
      .modal-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }
      .modal-content {
        background-color: white;
        padding: 2.5rem;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        transform: translateY(-20px);
        transition: transform 0.3s ease-in-out;
        width: 90%;
        max-width: 600px;
      }
      .modal-overlay.active .modal-content {
        transform: translateY(0);
      }
      .tooltip-bubble {
        bottom: 100%;
        right: 50%;
        transform: translateX(50%) translateY(-10px);
        z-index: 10;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
      }
      .tooltip-bubble::before {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-top: 15px solid #fff;
      }
      .tooltip-container:hover .tooltip-bubble {
        opacity: 1;
        pointer-events: auto;
        transform: translateX(50%) translateY(0);
      }
      .tab-button.active {
        border-bottom: 2px solid #60a5fa;
        color: #60a5fa;
      }
      .form-transition-container {
        position: relative;
        overflow: hidden;
      }
      .form-content {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        opacity: 0;
        pointer-events: none;
        transform: translateX(100%);
      }
      .form-content.active {
        position: relative;
        opacity: 1;
        pointer-events: auto;
        transform: translateX(0);
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800 comfortaa min-h-screen">
    <nav class="flex items-center justify-between px-6 py-4 border-b w-full">
      <div class="flex items-center space-x-2">
        <img src="./img/GLOT Logo.png" alt="G/LOT Logo" class="h-10 w-auto" />
      </div>
      <div class="flex space-x-8 text-lg">
        <a
          href="index.html"
          class="comfortaa text-black transition duration-200 hover:text-green-400 hover:scale-110"
          >Inicio</a
        >
        <a
          href="languages.html"
          class="comfortaa text-green-400 font-bold transition duration-200 hover:text-blue-400 hover:scale-110"
          >Aprender</a
        >
        <a
          href="profile.html"
          class="comfortaa text-black transition duration-200 hover:text-green-400 hover:scale-110"
          >Mi Aprendizaje</a
        >
        <a
          href="#"
          class="comfortaa text-black transition duration-200 hover:text-red-400 hover:scale-110"
          >Salir</a
        >
      </div>
    </nav>

    <main class="container mx-auto p-8">
      <div
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"
        id="idioma-container"
      ></div>
      <div class="fixed bottom-8 right-8 z-50">
        <button
          id="add-language-btn"
          class="bg-blue-400 hover:bg-blue-500 text-white p-6 rounded-full shadow-lg transition duration-300 transform hover:scale-110"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-8 w-8"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M12 4v16m8-8H4"
            />
          </svg>
        </button>
      </div>
    </main>

    <!-- Modal para agregar idioma/lección -->
    <div id="add-modal" class="modal-overlay" style="display: none">
      <div class="modal-content">
        <!-- Pestañas de navegación -->
        <div class="flex justify-center mb-6">
          <button
            id="tab-idioma"
            class="tab-button text-gray-500 font-bold px-4 py-2 mx-2 transition duration-300 ease-in-out hover:text-blue-400 hover:border-blue-400 active"
          >
            Idioma
          </button>
          <button
            id="tab-leccion"
            class="tab-button text-gray-500 font-bold px-4 py-2 mx-2 transition duration-300 ease-in-out hover:text-blue-400 hover:border-blue-400"
          >
            Lección
          </button>
        </div>

        <div class="form-transition-container">
          <!-- Formulario de Idioma -->
          <div id="form-idioma" class="form-content active">
            <h2 class="text-2xl font-bold mb-4">Agregar Nuevo Idioma</h2>
            <form id="add-language-form" class="space-y-4">
              <div>
                <label for="language-name" class="block text-left mb-1"
                  >Nombre</label
                >
                <input
                  type="text"
                  id="language-name"
                  class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
                  placeholder="Ej: Portugués"
                  required
                />
              </div>
              <div class="relative tooltip-container">
                <label for="language-code" class="block text-left mb-1"
                  >Código
                  <span class="text-gray-400 cursor-pointer text-xl">?</span>
                </label>
                <div
                  class="tooltip-bubble absolute bg-white p-4 rounded-lg shadow-md w-64 text-sm text-left"
                >
                  <p class="font-bold mb-2">Códigos de Países:</p>
                  <p>
                    El código debe ser de 2 letras, basado en el estándar de
                    banderas de países.
                  </p>
                  <p>Ejemplo: Español = ES</p>
                  <p class="mt-2">
                    Busca tu código
                    <a
                      href="https://www.iso.org/obp/ui/#search"
                      target="_blank"
                      class="text-blue-400 hover:underline"
                      >aquí</a
                    >.
                  </p>
                </div>
                <input
                  type="text"
                  id="language-code"
                  class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400 uppercase"
                  placeholder="Ej: BR"
                  maxlength="2"
                  required
                />
              </div>
              <div class="flex justify-end space-x-4 mt-6">
                <button
                  type="button"
                  id="cancel-add-btn"
                  class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full transition duration-300"
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  class="bg-blue-400 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-full transition duration-300"
                >
                  Registrar Idioma
                </button>
              </div>
            </form>
          </div>

          <!-- Formulario de Lección -->
          <div id="form-leccion" class="form-content">
            <h2 class="text-2xl font-bold mb-4">Agregar Nueva Lección</h2>
            <form id="add-lesson-form" class="space-y-4 text-left">
              <div>
                <label for="lesson-language-select" class="block mb-1"
                  >Selecciona el idioma</label
                >
                <select
                  id="lesson-language-select"
                  class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
                  required
                ></select>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block mb-1">Palabras Base</label>
                  <input
                    type="text"
                    name="word1"
                    placeholder="Palabra 1"
                    class="w-full border rounded-md px-3 py-2 mb-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
                    required
                  />
                  <input
                    type="text"
                    name="word2"
                    placeholder="Palabra 2"
                    class="w-full border rounded-md px-3 py-2 mb-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
                    required
                  />
                  <input
                    type="text"
                    name="word3"
                    placeholder="Palabra 3"
                    class="w-full border rounded-md px-3 py-2 mb-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
                    required
                  />
                  <input
                    type="text"
                    name="word4"
                    placeholder="Palabra 4"
                    class="w-full border rounded-md px-3 py-2 mb-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
                    required
                  />
                  <input
                    type="text"
                    name="word5"
                    placeholder="Palabra 5"
                    class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
                    required
                  />
                </div>
                <div>
                  <label class="block mb-1">Traducciones</label>
                  <input
                    type="text"
                    name="translation1"
                    placeholder="Traducción 1"
                    class="w-full border rounded-md px-3 py-2 mb-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
                    required
                  />
                  <input
                    type="text"
                    name="translation2"
                    placeholder="Traducción 2"
                    class="w-full border rounded-md px-3 py-2 mb-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
                    required
                  />
                  <input
                    type="text"
                    name="translation3"
                    placeholder="Traducción 3"
                    class="w-full border rounded-md px-3 py-2 mb-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
                    required
                  />
                  <input
                    type="text"
                    name="translation4"
                    placeholder="Traducción 4"
                    class="w-full border rounded-md px-3 py-2 mb-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
                    required
                  />
                  <input
                    type="text"
                    name="translation5"
                    placeholder="Traducción 5"
                    class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
                    required
                  />
                </div>
              </div>
              <div>
                <label for="lesson-game-type" class="block mb-1"
                  >Tipo de juego</label
                >
                <select
                  id="lesson-game-type"
                  class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
                  required
                >
                  <option value="">Selecciona un tipo</option>
                  <option value="Memoria">Memoria</option>
                  <option value="Asociar">Asociar</option>
                  <option value="Rellenar">Rellenar</option>
                </select>
              </div>
              <div class="flex justify-end space-x-4 mt-6">
                <button
                  type="button"
                  id="cancel-lesson-btn"
                  class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full transition duration-300"
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  class="bg-blue-400 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-full transition duration-300"
                >
                  Registrar Lección
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      async function verifyTokenOrRedirect() {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "login.html";
          return;
        }
        try {
          const res = await fetch("/api/verify-token", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token }),
          });
          const result = await res.json();
          if (!result.valid) {
            localStorage.removeItem("token");
            window.location.href = "login.html";
          }
        } catch (err) {
          window.location.href = "login.html";
        }
      }
      verifyTokenOrRedirect();
      // Salir button logic
      document.addEventListener("DOMContentLoaded", function () {
        localStorage.removeItem("lesson_id");
        const salirBtn = document.querySelector('a[href="#"]:nth-child(4)');
        if (!localStorage.getItem("token")) {
          salirBtn.style.display = "none";
        } else {
          salirBtn.style.display = "inline-block";
          salirBtn.onclick = function (e) {
            e.preventDefault();
            localStorage.removeItem("token");
            localStorage.removeItem("datosToken");
            localStorage.removeItem("usuario");
            localStorage.removeItem("lang");
            localStorage.removeItem("code");
            window.location.href = "login.html";
          };
        }
      });

      document.addEventListener("DOMContentLoaded", async function () {
        idiomas = await obtenerIdiomas();

        const container = document.getElementById("idioma-container");
        const addLanguageBtn = document.getElementById("add-language-btn");
        const addModal = document.getElementById("add-modal");
        const cancelAddBtn = document.getElementById("cancel-add-btn");
        const addLanguageForm = document.getElementById("add-language-form");
        const cancelLessonBtn = document.getElementById("cancel-lesson-btn");
        const addLessonForm = document.getElementById("add-lesson-form");

        const tabIdioma = document.getElementById("tab-idioma");
        const tabLeccion = document.getElementById("tab-leccion");
        const formIdioma = document.getElementById("form-idioma");
        const formLeccion = document.getElementById("form-leccion");
        const lessonLanguageSelect = document.getElementById(
          "lesson-language-select"
        );

        function renderLanguages() {
          container.innerHTML = "";

          // CODIGO PARA TOMAR LOS IDIOMAS DE LA BASE DE DATOS

          idiomas.forEach((idioma) => {
            const card = document.createElement("div");
            card.classList.add(
              "bg-white",
              "rounded-xl",
              "shadow-lg",
              "p-6",
              "flex",
              "flex-col",
              "items-center",
              "text-center",
              "border-2",
              "border-transparent",
              "hover:border-blue-400",
              "transition",
              "duration-300",
              "cursor-pointer"
            );
            card.onclick = () => {
              localStorage.setItem("lang", idioma.nombre);
              localStorage.setItem("code", idioma.codigo);
              window.location.href = `lessons.html`;
            };

            const flagImg = document.createElement("img");
            flagImg.src = `https://flagcdn.com/w160/${idioma.codigo.toLowerCase()}.png`;
            flagImg.alt = `Bandera de ${idioma.nombre}`;
            flagImg.classList.add(
              "w-20",
              "h-auto",
              "rounded-lg",
              "mb-4",
              "flagImg"
            );

            const nombre = document.createElement("h3");
            nombre.classList.add("text-2xl", "font-semibold", "mb-2");
            nombre.textContent = idioma.nombre;

            const lecciones = document.createElement("p");
            lecciones.classList.add("text-sm", "text-gray-500", "mb-1");
            lecciones.textContent = `Lecciones: ${idioma.cantidad_lecciones}`;

            const usuarios = document.createElement("p");
            usuarios.classList.add("text-sm", "text-gray-500");

            card.appendChild(flagImg);
            card.appendChild(nombre);
            card.appendChild(lecciones);
            card.appendChild(usuarios);

            container.appendChild(card);
          });
        }
        renderLanguages();

        // Lógica de los modales
        function openModal() {
          // Llenar el select de idiomas
          lessonLanguageSelect.innerHTML = "";
          idiomas.forEach((idioma) => {
            const option = document.createElement("option");
            option.value = idioma.nombre;
            option.textContent = idioma.nombre;
            lessonLanguageSelect.appendChild(option);
          });
          addModal.style.display = "flex";
          setTimeout(() => {
            addModal.classList.add("active");
          }, 10);
        }

        function closeModal() {
          addModal.classList.remove("active");
          addLanguageForm.reset();
          addLessonForm.reset();
          setTimeout(() => {
            addModal.style.display = "none";
          }, 300); // Wait for transition to finish
        }

        addLanguageBtn.addEventListener("click", openModal);
        cancelAddBtn.addEventListener("click", closeModal);
        cancelLessonBtn.addEventListener("click", closeModal);

        // Lógica de las pestañas
        function switchForm(formToShow) {
          if (formToShow === "idioma") {
            tabLeccion.classList.remove("active");
            tabIdioma.classList.add("active");
            formLeccion.classList.remove("active");
            formIdioma.classList.add("active");
          } else {
            tabIdioma.classList.remove("active");
            tabLeccion.classList.add("active");
            formIdioma.classList.remove("active");
            formLeccion.classList.add("active");
          }
        }

        tabIdioma.addEventListener("click", () => switchForm("idioma"));
        tabLeccion.addEventListener("click", () => switchForm("leccion"));

        // Lógica de los formularios
        addLanguageForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const name = document.getElementById("language-name").value;
          const code = document
            .getElementById("language-code")
            .value.toUpperCase();

          const newLanguage = {
            nombre: name,
            codigo: code,
            cantidad_lecciones: 0,
            usuarios_aprendiendo: 0,
          };

          registerLanguage(newLanguage);

          idiomas.push(newLanguage);
          renderLanguages();
          closeModal();
        });

        addLessonForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const selectedLanguage = lessonLanguageSelect.value;
          const gameType = document.getElementById("lesson-game-type").value;

          const words = [];
          for (let i = 1; i <= 5; i++) {
            words.push(document.querySelector(`input[name="word${i}"]`).value);
          }
          const translations = [];
          for (let i = 1; i <= 5; i++) {
            translations.push(
              document.querySelector(`input[name="translation${i}"]`).value
            );
          }

          const lessonData = {
            idioma: selectedLanguage,
            palabras: words,
            traducciones: translations,
            tipo: gameType,
            jugadas: 0,
            autor: localStorage.getItem("usuario"),
          };

          registerLesson(lessonData);

          console.log("Datos de la lección capturados:", lessonData);

          renderLanguages();

          closeModal();
        });

        async function registerLanguage(datos) {
          const respuesta = await fetch("/api/idiomas", {
            method: "POST",

            // Busca el token en query params o en headers
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
              "Content-Type": "application/json",
            },
            body: JSON.stringify(datos),
          });

          if (!respuesta.ok) {
            const error = await respuesta.json();
            throw new Error(error.error || "Error al registrar idioma");
          }
          const resultado = await respuesta.json();
          console.log("Idioma registrado:", resultado);
        }

        async function obtenerIdiomas() {
          const respuesta = await fetch("/api/idiomas", {
            method: "GET",
            // Busca el token en query params o en headers
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
              "Content-Type": "application/json",
            },
          });

          if (!respuesta.ok) {
            const error = await respuesta.json();
            throw new Error(error.error || "Error al obtener idiomas");
          }
          const resultado = await respuesta.json();
          const idiomas = resultado.map((idioma) => ({
            nombre: idioma.nombre,
            codigo: idioma.codigo,
            cantidad_lecciones: idioma.cantidad_lecciones ? idioma.cantidad_lecciones : 0,
            usuarios_aprendiendo: 0, // Este dato debería venir del backend
          }));
          return idiomas;
        }

        async function registerLesson(datos) {
          const respuesta = await fetch("/api/lecciones", {
            method: "POST",
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
              "Content-Type": "application/json",
            },
            body: JSON.stringify(datos),
          });

          if (!respuesta.ok) {
            const error = await respuesta.json();
            throw new Error(error.error || "Error al registrar lección");
          }

          const resultado = await respuesta.json();
          console.log("Lección registrada:", resultado);

          const idiomaNombre = datos.idioma;

          const updateIdioma = await fetch(`/api/idiomas/${idiomaNombre}`, {
            method: "PUT",
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              cantidad_lecciones:
                idiomas.find((i) => i.nombre === datos.idioma)
                  .cantidad_lecciones + 1,
              
            }),
          });
          if (!updateIdioma.ok) {
            const error = await updateIdioma.json();
            throw new Error(error.error || "Error al actualizar idioma");
          }
        }
      });
    </script>
  </body>
</html>
